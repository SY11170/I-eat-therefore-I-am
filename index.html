<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 吃吃喝喝統計表 - Mobile Optimized</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f4f6f8;
            color: #546e7a;
            -webkit-tap-highlight-color: transparent;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
        }
        .calendar-cell {
            aspect-ratio: 1 / 1.1; /* 讓格子接近正方形，稍微保留一點空間給標籤 */
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
    </style>
</head>
<body class="p-3 md:p-8">

    <div id="loading" class="loading-overlay">
        <div class="flex flex-col items-center gap-4">
            <div class="w-10 h-10 border-4 border-[#91a5b8] border-t-transparent rounded-full animate-spin"></div>
            <p class="font-black text-[#91a5b8] text-sm tracking-widest">資料同步中...</p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto space-y-4">
        <!-- 頂部資訊與統計 -->
        <div class="bg-white rounded-[2rem] p-5 md:p-8 shadow-sm border border-slate-200/60">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-black text-[#455a64] tracking-tight">2026 紀錄</h1>
                    <p class="text-[10px] text-[#b0bec5] font-bold uppercase tracking-tighter">Cloud Sync Active</p>
                </div>
                <div id="month-picker-main"></div>
            </div>

            <!-- 縮窄後的統計欄位 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6" id="stats-container"></div>

            <div class="pt-5 border-t border-slate-100">
                <div class="flex items-center gap-2 mb-4 overflow-x-auto hide-scrollbar pb-2" id="config-container"></div>
                <div class="grid grid-cols-1 gap-3" id="favorites-container"></div>
            </div>
        </div>

        <!-- 優化後的方型月曆 -->
        <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200/60 p-4 space-y-4">
            <div class="flex items-center justify-between px-1">
                <div id="month-picker-calendar"></div>
                <span class="text-[9px] font-black text-[#cfd8dc] uppercase tracking-[0.2em]">Calendar</span>
            </div>
            <div id="calendar-view"></div>
        </div>
    </div>

    <!-- Modal 保持不變但優化手機端內距 -->
    <div id="modal" class="fixed inset-0 bg-[#263238]/40 backdrop-blur-md z-50 hidden flex items-center justify-center p-2">
        <div class="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-white/80 sticky top-0 z-10">
                <div class="flex items-center gap-2">
                    <button onclick="shiftSelectedDate(-1)" class="w-10 h-10 flex items-center justify-center hover:bg-slate-50 rounded-full text-[#b0bec5]">❮</button>
                    <h2 id="modal-date-title" class="text-xl font-black text-[#455a64]"></h2>
                    <button onclick="shiftSelectedDate(1)" class="w-10 h-10 flex items-center justify-center hover:bg-slate-50 rounded-full text-[#b0bec5]">❯</button>
                </div>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-full text-[#b0bec5]">✕</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-8 hide-scrollbar pb-20">
                <div class="space-y-4" id="record-columns"></div>
                <div class="pt-8 border-t border-slate-100">
                    <h3 class="text-sm font-black text-[#90a4ae] mb-6 uppercase tracking-widest">新增/修改項目</h3>
                    <div class="grid grid-cols-1 gap-4" id="forms-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'diet-app-2026';

        let records = {};
        let statsConfig = { breakfast: true, lunch: true, dinner: true, nightSnack: true, instantNoodles: true, drinks: true };
        let currentDate = new Date(2026, 0, 1);
        let selectedDateStr = null;
        let editingItem = null;
        let currentUser = null;

        const CATEGORIES = {
            breakfast: { label: '早', tag: '食' },
            lunch: { label: '午', tag: '食' },
            dinner: { label: '晚', tag: '食' },
            nightSnack: { label: '宵', tag: '食' },
            instantNoodles: { label: '泡', tag: '食' },
            drinks: { label: '飲', tag: '飲' },
            exercise: { label: '動', tag: '動' },
            weight: { label: '重', tag: '重' }
        };

        // 初始化
        async function initApp() {
            try {
                await signInAnonymously(auth);
                onAuthStateChanged(auth, (user) => { if (user) { currentUser = user; setupSync(); } });
            } catch (e) { document.getElementById('loading').innerText = "連線失敗"; }
        }

        function setupSync() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'all_records');
            onSnapshot(docRef, (snapshot) => {
                if (snapshot.exists()) records = snapshot.data().content || {};
                document.getElementById('loading').classList.add('hidden');
                renderAll();
                if (selectedDateStr) renderModalContent();
            });
        }

        async function sync() {
            if (!currentUser) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'all_records'), { content: records });
        }

        // 渲染統計卡片 (縮窄版)
        function renderStats() {
            const s = calculateStats();
            document.getElementById('stats-container').innerHTML = `
                ${statCard('月累計', s.monthlySpend, '$', 'bg-[#e9eff5]', 'text-[#91a5b8]')}
                ${statCard('年累計', s.yearlySpend, '$', 'bg-[#f1f3f5]', 'text-[#7e8a97]')}
                ${statCard('月杯數', s.monthlyCups, '杯', 'bg-[#f7f3ef]', 'text-[#c1a07d]')}
                ${statCard('年杯數', s.yearlyCups, '杯', 'bg-[#f8f9fa]', 'text-[#90a4ae]')}
            `;
        }

        function statCard(t, v, u, bg, tc) {
            return `<div class="${bg} p-4 rounded-2xl border border-white/60 shadow-sm"><p class="text-[9px] font-black text-[#b0bec5] mb-1">${t}</p><p class="text-lg font-black ${tc}">${v.toLocaleString()}<span class="text-[10px] opacity-40 ml-1 font-normal">${u}</span></p></div>`;
        }

        // 渲染月曆 (方形 & 小標籤)
        function renderCalendar() {
            const y = currentDate.getFullYear();
            const m = currentDate.getMonth();
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const firstDay = new Date(y, m, 1).getDay();
            
            let html = `<div class="calendar-grid border-l border-t border-slate-100 rounded-xl overflow-hidden shadow-sm">`;
            ['日','一','二','三','四','五','六'].forEach(d => {
                html += `<div class="bg-[#f8f9fa] py-2 text-center text-[9px] font-bold text-[#cfd8dc] border-r border-b border-slate-100">${d}</div>`;
            });

            for (let i = 0; i < firstDay; i++) html += `<div class="calendar-cell border-r border-b border-slate-50 bg-slate-50/10"></div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const data = records[dateStr];
                const isToday = d === new Date().getDate() && m === new Date().getMonth() && y === new Date().getFullYear();
                
                html += `
                    <div onclick="openModal('${dateStr}')" class="calendar-cell border-r border-b border-slate-100 p-1.5 cursor-pointer hover:bg-slate-50 bg-white relative">
                        <span class="text-[10px] font-black ${isToday ? 'bg-[#91a5b8] text-white w-5 h-5 flex items-center justify-center rounded-md' : 'text-[#b0bec5]'}">${d}</span>
                        <div class="flex flex-wrap gap-0.5 mt-1.5">
                            ${data?.meals?.length > 0 ? `<div class="w-1.5 h-1.5 rounded-full bg-[#91a5b8]"></div>` : ''}
                            ${data?.drinks?.length > 0 ? `<div class="w-1.5 h-1.5 rounded-full bg-[#c1a07d]"></div>` : ''}
                            ${data?.exercise?.length > 0 ? `<div class="w-1.5 h-1.5 rounded-full bg-[#8da69d]"></div>` : ''}
                        </div>
                    </div>
                `;
            }
            document.getElementById('calendar-view').innerHTML = html + `</div>`;
        }

        // 其餘邏輯
        function calculateStats() {
            let mS = 0, yS = 0, mC = 0, yC = 0;
            const mK = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
            Object.entries(records).forEach(([date, data]) => {
                const isM = date.startsWith(mK);
                const dS = (data.meals?.reduce((a, m) => a + (statsConfig[m.type] ? (parseInt(m.amount) || 0) : 0), 0) || 0) + (data.drinks?.reduce((a, d) => a + (statsConfig.drinks ? (parseInt(d.amount) || 0) : 0), 0) || 0);
                if (isM) { mS += dS; mC += (data.drinks?.length || 0); }
                yS += dS; yC += (data.drinks?.length || 0);
            });
            return { monthlySpend: mS, yearlySpend: yS, monthlyCups: mC, yearlyCups: yC };
        }

        function renderMonthPickers() {
            const h = `
                <div class="flex items-center gap-1 bg-[#f1f3f5] p-1 rounded-xl border border-slate-200">
                    <button onclick="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-lg shadow-sm text-xs text-[#90a4ae]">❮</button>
                    <span class="text-xs font-black px-2 min-w-[80px] text-center text-[#546e7a]">${currentDate.getFullYear()}/${currentDate.getMonth() + 1}</span>
                    <button onclick="changeMonth(1)" class="w-8 h-8 flex items-center justify-center bg-white rounded-lg shadow-sm text-xs text-[#90a4ae]">❯</button>
                </div>
            `;
            document.getElementById('month-picker-main').innerHTML = h;
            document.getElementById('month-picker-calendar').innerHTML = h;
        }

        function renderConfig() {
            document.getElementById('config-container').innerHTML = ['breakfast', 'lunch', 'dinner', 'drinks'].map(k => `
                <button onclick="toggleConfig('${k}')" class="whitespace-nowrap px-4 py-2 rounded-xl text-[10px] font-black transition-all border ${statsConfig[k] ? 'bg-[#91a5b8] border-[#91a5b8] text-white' : 'bg-white border-slate-200 text-[#b0bec5]'}">
                    ${CATEGORIES[k].label}
                </button>
            `).join('');
        }

        window.openModal = (d) => { selectedDateStr = d; document.getElementById('modal').classList.remove('hidden'); renderModalContent(); };
        window.closeModal = () => { selectedDateStr = null; document.getElementById('modal').classList.add('hidden'); };
        window.changeMonth = (o) => { currentDate.setMonth(currentDate.getMonth() + o); renderAll(); };
        window.toggleConfig = (k) => { statsConfig[k] = !statsConfig[k]; renderAll(); };
        window.shiftSelectedDate = (o) => {
            const d = new Date(selectedDateStr); d.setDate(d.getDate() + o);
            selectedDateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            if(d.getMonth() !== currentDate.getMonth()) { currentDate = new Date(d.getFullYear(), d.getMonth(), 1); renderAll(); }
            renderModalContent();
        };

        function renderModalContent() {
            document.getElementById('modal-date-title').innerText = selectedDateStr;
            const data = records[selectedDateStr] || { meals: [], drinks: [], exercise: [] };
            document.getElementById('record-columns').innerHTML = `
                <div class="bg-slate-50 p-5 rounded-[2rem] space-y-3">
                    <p class="text-[9px] font-black text-[#b0bec5] uppercase tracking-widest mb-2">明細</p>
                    ${[...data.meals, ...data.drinks].map((m, i) => `
                        <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm">
                            <div>
                                <span class="text-[9px] font-bold text-[#91a5b8] uppercase">${m.type ? CATEGORIES[m.type].label : '飲'}</span>
                                <p class="text-sm font-black text-[#455a64]">${m.name}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-sm font-black text-[#91a5b8]">$${m.amount}</p>
                                <button onclick="deleteRec('${m.type ? 'meals' : 'drinks'}', ${i})" class="text-[9px] text-red-300 font-bold uppercase mt-1">Delete</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            renderForms();
        }

        function renderForms() {
            document.getElementById('forms-container').innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <input id="f-name" placeholder="名稱" class="col-span-2 bg-slate-50 rounded-xl p-4 text-sm font-bold outline-none border border-transparent focus:border-[#91a5b8]" />
                    <input id="f-amount" type="number" placeholder="金額" class="bg-slate-50 rounded-xl p-4 text-sm font-bold outline-none border border-transparent focus:border-[#91a5b8]" />
                    <select id="f-type" class="bg-slate-50 rounded-xl p-4 text-sm font-bold outline-none border border-transparent focus:border-[#91a5b8]">
                        <option value="lunch">午餐</option><option value="dinner">晚餐</option><option value="drinks">手搖</option><option value="breakfast">早餐</option>
                    </select>
                    <button onclick="addRec()" class="col-span-2 bg-[#455a64] text-white font-black py-4 rounded-xl shadow-lg active:scale-95 transition-all">確認加入</button>
                </div>
            `;
        }

        window.addRec = async () => {
            const n = document.getElementById('f-name').value;
            const a = document.getElementById('f-amount').value;
            const t = document.getElementById('f-type').value;
            if(!n || !a) return;
            if(!records[selectedDateStr]) records[selectedDateStr] = { meals: [], drinks: [], exercise: [] };
            if(t === 'drinks') records[selectedDateStr].drinks.push({ name: n, amount: a });
            else records[selectedDateStr].meals.push({ name: n, amount: a, type: t });
            await sync();
        };

        window.deleteRec = async (k, i) => { records[selectedDateStr][k].splice(i, 1); await sync(); };

        function renderAll() {
            renderMonthPickers();
            renderStats();
            renderConfig();
            renderCalendar();
            // Favorites 可依需求簡化或保留，此處先隱藏確保空間
            document.getElementById('favorites-container').innerHTML = '';
        }

        initApp();
    </script>
</body>
</html>
