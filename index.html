import React, { useState, useEffect, useMemo } from 'react';
import { 
  ChevronLeft, 
  ChevronRight, 
  Plus, 
  Utensils, 
  Apple, 
  Droplets, 
  Moon, 
  X,
  Trash2,
  Edit2,
  Scale,
  Dumbbell,
  MapPin,
  MessageSquare,
  DollarSign,
  Soup
} from 'lucide-react';

// 自定義飲品圖示
const DrinkIcon = ({ size = 14, className = "" }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
    <path d="M17 2l-.5 5h-9l-.5-5" />
    <path d="M7 7l1.5 14h7L17 7" />
    <path d="M11 2v5" />
    <path d="M9 2h4" />
  </svg>
);

const App = () => {
  // --- 狀態管理 ---
  const [currentDate, setCurrentDate] = useState(new Date(2026, 0, 1));
  const [records, setRecords] = useState({}); 
  const [selectedDate, setSelectedDate] = useState(null);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingItem, setEditingItem] = useState(null); 
  
  const [statsConfig, setStatsConfig] = useState({
    breakfast: true, lunch: true, dinner: true, nightSnack: true, instantNoodles: true, drinks: true
  });

  // --- 莫蘭迪配色常數定義 ---
  const COLORS = {
    blue: '#91a5b8',    // 莫蘭迪藍
    grey: '#7e8a97',    // 莫蘭迪灰
    green: '#a1b39b',   // 莫蘭迪綠
    dustyRose: '#b08e8e', // 莫蘭迪粉/紅
    clay: '#c7b198',    // 莫蘭迪土色/手搖
    dark: '#546e7a',    // 深灰藍 (文字)
    bg: '#f0f2f5'       // 淺灰背景
  };

  const CATEGORIES = {
    breakfast: { label: '早餐', color: 'text-[#91a5b8]', icon: <Utensils size={14} className="text-[#91a5b8]" /> },
    lunch: { label: '午餐', color: 'text-[#8297a8]', icon: <Utensils size={14} className="text-[#8297a8]" /> },
    dinner: { label: '晚餐', color: 'text-[#a1b39b]', icon: <Utensils size={14} className="text-[#a1b39b]" /> },
    nightSnack: { label: '宵夜', color: 'text-[#7e8a97]', icon: <Moon size={14} className="text-[#7e8a97]" /> },
    instantNoodles: { label: '泡麵', color: 'text-[#b08e8e]', icon: <Soup size={14} className="text-[#b08e8e]" /> },
    drinks: { label: '手搖', color: 'text-[#c7b198]', icon: <DrinkIcon size={14} className="text-[#c7b198]" /> },
    fruits: { label: '水果', color: 'text-[#a1b39b]', icon: <Apple size={14} className="text-[#a1b39b]" /> },
    water: { label: '飲水', color: 'text-[#9eb8c0]', icon: <Droplets size={14} className="text-[#9eb8c0]" /> },
    exercise: { label: '運動', color: 'text-[#8da69d]', icon: <Dumbbell size={14} className="text-[#8da69d]" /> },
    weight: { label: '體重', color: 'text-[#a3a3a3]', icon: <Scale size={14} className="text-[#a3a3a3]" /> }
  };

  const ICE_OPTIONS = ['正常冰', '少冰', '微冰', '去冰', '完全不冰', '無法調整'];
  const SUGAR_OPTIONS = ['正常甜', '少糖', '半糖', '微糖', '無糖', '無法調整'];

  // --- 功能函數 ---
  const changeMonth = (offset) => {
    setCurrentDate(prev => new Date(prev.getFullYear(), prev.getMonth() + offset, 1));
  };

  const shiftSelectedDate = (days) => {
    if (!selectedDate) return;
    const current = new Date(selectedDate);
    current.setDate(current.getDate() + days);
    const nextDateStr = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
    setSelectedDate(nextDateStr);
    setEditingItem(null);
    if (current.getMonth() !== currentDate.getMonth() || current.getFullYear() !== currentDate.getFullYear()) {
      setCurrentDate(new Date(current.getFullYear(), current.getMonth(), 1));
    }
  };

  const saveRecord = (dateStr, type, data, index = null) => {
    setRecords(prev => {
      const dayData = JSON.parse(JSON.stringify(prev[dateStr] || { 
        meals: [], drinks: [], fruits: [], exercise: [], weight: '', water: 0 
      }));
      if (type === 'water') dayData.water = parseInt(data.amount || 0);
      else if (type === 'weight') dayData.weight = data.amount;
      else {
        const key = type === 'drinks' ? 'drinks' : (type === 'fruits' ? 'fruits' : (type === 'exercise' ? 'exercise' : 'meals'));
        const itemData = (type === 'drinks' || type === 'fruits' || type === 'exercise') ? data : { ...data, type };
        if (index !== null) dayData[key][index] = itemData;
        else dayData[key].push(itemData);
      }
      return { ...prev, [dateStr]: dayData };
    });
    setEditingItem(null);
  };

  const deleteItem = (dateStr, categoryKey, index) => {
    setRecords(prev => {
      const newRecords = { ...prev };
      const dayData = JSON.parse(JSON.stringify(newRecords[dateStr]));
      dayData[categoryKey].splice(index, 1);
      newRecords[dateStr] = dayData;
      return newRecords;
    });
  };

  const stats = useMemo(() => {
    let monthlySpend = 0, yearlySpend = 0;
    let monthlyCups = 0, yearlyCups = 0;
    let drinkFreq = { monthly: {}, yearly: {} };
    let mealFreq = { monthly: {}, yearly: {} };

    const curMonthStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
    const curYearStr = `${currentDate.getFullYear()}`;

    Object.entries(records).forEach(([date, data]) => {
      const isMonth = date.startsWith(curMonthStr);
      const isYear = date.startsWith(curYearStr);
      const dailySpend = (data.meals?.reduce((acc, m) => acc + (statsConfig[m.type] ? (parseInt(m.amount) || 0) : 0), 0) || 0) +
                        (data.drinks?.reduce((acc, d) => acc + (statsConfig.drinks ? (parseInt(d.amount) || 0) : 0), 0) || 0);
      if (isMonth) monthlySpend += dailySpend;
      if (isYear) yearlySpend += dailySpend;
      const dailyCups = data.drinks?.length || 0;
      if (isMonth) monthlyCups += dailyCups;
      if (isYear) yearlyCups += dailyCups;
      data.drinks?.forEach(d => {
        const key = `${d.brand} ${d.name}`.trim() || '未命名飲品';
        if (isMonth) drinkFreq.monthly[key] = (drinkFreq.monthly[key] || 0) + 1;
        if (isYear) drinkFreq.yearly[key] = (drinkFreq.yearly[key] || 0) + 1;
      });
      data.meals?.forEach(m => {
        if (statsConfig[m.type]) {
          const key = `${m.brand} ${m.name}`.trim() || '未命名項目';
          if (isMonth) mealFreq.monthly[key] = (mealFreq.monthly[key] || 0) + 1;
          if (isYear) mealFreq.yearly[key] = (mealFreq.yearly[key] || 0) + 1;
        }
      });
    });

    const getTopItems = (freq, unit) => {
      const entries = Object.entries(freq);
      if (entries.length === 0) return { text: '無數據', count: 0 };
      const maxCount = Math.max(...entries.map(e => e[1]));
      const tops = entries.filter(e => e[1] === maxCount).map(e => e[0]);
      return { text: tops.join(', '), count: maxCount, unit: unit };
    };

    return { 
      monthlySpend, yearlySpend, monthlyCups, yearlyCups,
      topDrinkMonth: getTopItems(drinkFreq.monthly, '杯'),
      topDrinkYear: getTopItems(drinkFreq.yearly, '杯'),
      topMealMonth: getTopItems(mealFreq.monthly, '次'),
      topMealYear: getTopItems(mealFreq.yearly, '次')
    };
  }, [records, currentDate, statsConfig]);

  // --- 月曆元件 ---
  const Calendar = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDay = new Date(year, month, 1).getDay();
    const days = [];

    for (let i = 0; i < firstDay; i++) {
      days.push(<div key={`empty-${i}`} className="h-32 border border-slate-100 bg-slate-50/20"></div>);
    }

    for (let d = 1; d <= daysInMonth; d++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
      const dayData = records[dateStr];
      const isToday = d === new Date().getDate() && month === new Date().getMonth() && year === new Date().getFullYear();

      days.push(
        <div 
          key={d} 
          onClick={() => { setSelectedDate(dateStr); setIsModalOpen(true); }}
          className="h-32 border border-slate-100 p-2 cursor-pointer hover:bg-[#f4f7f9] transition-all relative group bg-white"
        >
          <span className={`text-xs font-bold w-6 h-6 flex items-center justify-center rounded-lg ${isToday ? 'bg-[#91a5b8] text-white shadow-lg shadow-[#91a5b8]/20' : 'text-[#90a4ae]'}`}>
            {d}
          </span>
          
          <div className="flex flex-wrap gap-1.5 mt-2">
            {dayData?.meals?.length > 0 && <Utensils size={14} className="text-[#91a5b8] opacity-70" />}
            {dayData?.drinks?.length > 0 && <DrinkIcon size={14} className="text-[#c7b198] opacity-70" />}
            {dayData?.exercise?.length > 0 && <Dumbbell size={14} className="text-[#8da69d] opacity-70" />}
          </div>

          <div className="absolute bottom-2 left-2 right-2 flex flex-col items-start gap-0.5">
            {dayData?.water > 0 && (
              <div className="flex items-center gap-1 text-[10px] font-black text-[#718d96] bg-[#eef5f7] px-1 rounded">
                <Droplets size={10}/> {dayData.water}ml
              </div>
            )}
            {dayData?.weight && (
              <div className="flex items-center gap-1 text-[10px] font-black text-[#90a4ae] bg-slate-100 px-1 rounded">
                <Scale size={10}/> {dayData.weight}kg
              </div>
            )}
          </div>
        </div>
      );
    }

    return (
      <div className="grid grid-cols-7 border-l border-t border-slate-200 rounded-[1.5rem] overflow-hidden shadow-sm">
        {['日', '一', '二', '三', '四', '五', '六'].map(d => (
          <div key={d} className="bg-[#f8f9fa] py-3 text-center text-[10px] font-bold text-[#b0bec5] border-r border-b border-slate-200 uppercase tracking-widest">
            {d}
          </div>
        ))}
        {days}
      </div>
    );
  };

  const DatePickerControl = ({ size = "small" }) => (
    <div className={`flex items-center gap-2 bg-[#f1f3f5] p-1.5 rounded-2xl w-fit border border-slate-200 ${size === "large" ? "px-4 py-2" : ""}`}>
      <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-white rounded-xl transition-all shadow-sm text-[#78909c]">
        <ChevronLeft size={size === "large" ? 20 : 16}/>
      </button>
      <span className={`${size === "large" ? "text-sm" : "text-xs"} font-black text-[#546e7a] min-w-[100px] text-center`}>
        {currentDate.getFullYear()} 年 {currentDate.getMonth() + 1} 月
      </span>
      <button onClick={() => changeMonth(1)} className="p-2 hover:bg-white rounded-xl transition-all shadow-sm text-[#78909c]">
        <ChevronRight size={size === "large" ? 20 : 16}/>
      </button>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#f0f2f5] p-4 md:p-8 text-[#546e7a] font-sans">
      <div className="max-w-7xl mx-auto space-y-8">
        
        {/* 頂部統計卡片 (莫蘭迪色調) */}
        <div className="bg-white rounded-[2.5rem] p-8 md:p-10 shadow-sm border border-slate-200/50">
          <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-10">
            <div>
              <h1 className="text-4xl font-black text-[#455a64] tracking-tight mb-2">2026 吃吃喝喝</h1>
              <p className="text-sm text-[#90a4ae] font-bold italic">我吃故我在</p>
            </div>
          </div>

          <div className="mb-10">
            <DatePickerControl size="large" />
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 mb-12">
            <StatCard title="當月累計消費" value={stats.monthlySpend} unit="$" icon={<DollarSign size={20}/>} color="text-[#91a5b8]" bgColor="bg-[#e9eff5]" />
            <StatCard title="當年累計消費" value={stats.yearlySpend} unit="$" icon={<DollarSign size={20}/>} color="text-[#7e8a97]" bgColor="bg-[#f1f3f5]" />
            <StatCard title="當月累計杯數" value={stats.monthlyCups} unit="杯" icon={<DrinkIcon size={20}/>} color="text-[#c1a07d]" bgColor="bg-[#f7f3ef]" />
            <StatCard title="當年累計杯數" value={stats.yearlyCups} unit="杯" icon={<DrinkIcon size={20}/>} color="text-[#90a4ae]" bgColor="bg-[#f8f9fa]" />
          </div>

          <div className="pt-10 border-t border-slate-100 space-y-8">
            <div className="flex flex-col md:flex-row items-start md:items-center gap-4">
              <span className="text-[10px] font-black text-[#90a4ae] uppercase tracking-widest">統計計入類別：</span>
              <div className="flex flex-wrap gap-2">
                {['breakfast', 'lunch', 'dinner', 'nightSnack', 'instantNoodles', 'drinks'].map(key => (
                  <label key={key} className={`flex items-center gap-2 px-5 py-2.5 rounded-2xl text-xs font-black cursor-pointer transition-all border ${statsConfig[key] ? 'bg-[#91a5b8] border-[#91a5b8] text-white shadow-md shadow-[#91a5b8]/10' : 'bg-white border-slate-200 text-[#90a4ae] hover:border-[#91a5b8]'}`}>
                    <input type="checkbox" className="hidden" checked={statsConfig[key]} onChange={() => setStatsConfig(p => ({...p, [key]: !p[key]}))} />
                    {CATEGORIES[key].label}
                  </label>
                ))}
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="space-y-4">
                <FavoriteDisplay label="本月最愛飲品" data={stats.topDrinkMonth} icon={<DrinkIcon className="text-[#c1a07d]" />} activeColor="text-[#c1a07d]" bgColor="bg-[#fdfaf7]" />
                <FavoriteDisplay label="本月最愛吃" data={stats.topMealMonth} icon={<Utensils size={14} className="text-[#91a5b8]" />} activeColor="text-[#71869d]" bgColor="bg-[#f8fafb]" />
              </div>
              <div className="space-y-4">
                <FavoriteDisplay label="今年最愛飲品" data={stats.topDrinkYear} icon={<DrinkIcon className="text-[#90a4ae]" />} activeColor="text-[#90a4ae]" bgColor="bg-[#f8f9fa]" />
                <FavoriteDisplay label="今年最愛吃" data={stats.topMealYear} icon={<Utensils size={14} className="text-[#90a4ae]" />} activeColor="text-[#90a4ae]" bgColor="bg-[#f8f9fa]" />
              </div>
            </div>
          </div>
        </div>

        {/* 月曆顯示區域 */}
        <div className="bg-white rounded-[2.5rem] shadow-sm border border-slate-200/50 p-8 space-y-6">
          <div className="flex items-center justify-between">
            <DatePickerControl />
            <div className="text-[10px] font-bold text-[#b0bec5] uppercase tracking-widest">Calendar View</div>
          </div>
          <Calendar />
        </div>

        {/* 詳情與編輯彈窗 */}
        {isModalOpen && (
          <div className="fixed inset-0 bg-[#263238]/40 backdrop-blur-md z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-[3.5rem] shadow-2xl w-full max-w-6xl max-h-[92vh] overflow-hidden flex flex-col border border-white/20">
              <div className="p-8 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white/80 backdrop-blur-md z-10">
                <div className="flex items-center gap-4">
                  <button onClick={() => shiftSelectedDate(-1)} className="p-3 hover:bg-slate-50 rounded-full text-[#b0bec5] transition-all"><ChevronLeft size={24}/></button>
                  <h2 className="text-3xl font-black text-[#455a64] tracking-tight">{selectedDate}</h2>
                  <button onClick={() => shiftSelectedDate(1)} className="p-3 hover:bg-slate-50 rounded-full text-[#b0bec5] transition-all"><ChevronRight size={24}/></button>
                </div>
                <button onClick={() => { setIsModalOpen(false); setEditingItem(null); }} className="p-4 hover:bg-[#ffebee] hover:text-[#e57373] rounded-full transition-all text-[#b0bec5]"><X size={32}/></button>
              </div>
              
              <div className="flex-1 overflow-y-auto p-8 space-y-12">
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                  <RecordColumn 
                    title="飲食清單" 
                    items={records[selectedDate]?.meals || []} 
                    onEdit={(item, i) => setEditingItem({ type: item.type, index: i, data: item })}
                    onDelete={(i) => deleteItem(selectedDate, 'meals', i)}
                    render={(m) => (
                      <div className="space-y-2">
                        <div className="flex justify-between items-start">
                          <div className="space-y-1">
                            <span className={`text-[10px] font-black px-2 py-0.5 rounded-lg border uppercase ${m.type === 'instantNoodles' ? 'bg-[#fbe9e7] border-[#ffccbc] text-[#d84315]' : 'bg-[#e9eff5] border-[#d1dce7] text-[#546e7a]'}`}>
                              {CATEGORIES[m.type].label}
                            </span>
                            <div className="text-base font-black text-[#455a64]">
                              {m.brand && <span className="text-[#91a5b8] mr-1">[{m.brand}]</span>}
                              {m.name}
                            </div>
                          </div>
                          <span className="text-lg font-black text-[#71869d]">${m.amount}</span>
                        </div>
                        {m.note && <div className="text-xs text-slate-400 flex items-center gap-1 bg-slate-50 p-2 rounded-xl border border-slate-100"><MessageSquare size={12}/> {m.note}</div>}
                      </div>
                    )}
                  />
                  <RecordColumn 
                    title="手搖飲" 
                    items={records[selectedDate]?.drinks || []} 
                    onEdit={(item, i) => setEditingItem({ type: 'drinks', index: i, data: item })}
                    onDelete={(i) => deleteItem(selectedDate, 'drinks', i)}
                    render={(d) => (
                      <div className="space-y-3">
                        <div className="flex justify-between font-black text-[#455a64]">
                          <span className="text-base">{d.brand && <span className="text-[#c1a07d] mr-1">[{d.brand}]</span>}{d.name}</span>
                          <span className="text-[#c1a07d] text-lg">${d.amount}</span>
                        </div>
                        <div className="flex gap-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                          <span className="bg-[#f7f3ef] px-2 py-0.5 rounded-lg border border-[#f2ece5]">{d.ice}</span>
                          <span className="bg-[#f7f3ef] px-2 py-0.5 rounded-lg border border-[#f2ece5]">{d.sugar}</span>
                        </div>
                        {d.note && <div className="text-xs text-slate-400 flex items-center gap-1 bg-slate-50 p-2 rounded-xl border border-slate-100"><MessageSquare size={12}/> {d.note}</div>}
                      </div>
                    )}
                  />
                  <RecordColumn 
                    title="生活與運動" 
                    items={records[selectedDate]?.exercise || []} 
                    onEdit={(item, i) => setEditingItem({ type: 'exercise', index: i, data: item })}
                    onDelete={(i) => deleteItem(selectedDate, 'exercise', i)}
                    header={records[selectedDate]?.weight && (
                      <div className="mb-4 p-5 bg-[#455a64] rounded-3xl flex items-center justify-between text-white shadow-lg shadow-[#455a64]/20 border border-white/10">
                        <div className="flex items-center gap-2 font-black text-xs uppercase tracking-widest opacity-70"><Scale size={18}/> 體重</div>
                        <span className="text-2xl font-black">{records[selectedDate].weight} <small className="text-xs font-normal opacity-50">kg</small></span>
                      </div>
                    )}
                    footer={records[selectedDate]?.water > 0 && (
                      <div className="mt-4 p-5 bg-[#9eb8c0] rounded-3xl flex items-center justify-between text-white shadow-lg shadow-[#9eb8c0]/20 border border-white/10">
                        <div className="flex items-center gap-2 font-black text-xs uppercase tracking-widest opacity-80"><Droplets size={18}/> 飲水</div>
                        <span className="text-2xl font-black">{records[selectedDate].water} <small className="text-xs font-normal opacity-50">ml</small></span>
                      </div>
                    )}
                    render={(e) => (
                      <div className="space-y-1">
                        <div className="text-base font-black text-[#455a64] flex items-center gap-2">
                           <div className="p-2 bg-[#f1f5f3] rounded-xl text-[#8da69d]"><Dumbbell size={16}/></div>
                           {e.name} {e.time && <span className="text-xs font-normal text-slate-400">({e.time})</span>}
                        </div>
                        {e.location && <div className="text-xs text-[#90a4ae] flex items-center gap-1 ml-10"><MapPin size={12}/> {e.location}</div>}
                        {e.note && <div className="text-xs text-[#90a4ae] flex items-center gap-1 ml-10"><MessageSquare size={12}/> {e.note}</div>}
                      </div>
                    )}
                  />
                </div>

                <div className="pt-12 border-t border-slate-100">
                  <h3 className="text-xl font-black text-[#455a64] mb-8 flex items-center gap-3">
                    <div className="p-2 bg-[#91a5b8] text-white rounded-2xl shadow-lg shadow-[#91a5b8]/20">
                      {editingItem ? <Edit2 size={24}/> : <Plus size={24}/>}
                    </div>
                    {editingItem ? '修改紀錄' : '新增紀錄'}
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-8">
                    <MealForm initialData={editingItem && !['drinks', 'exercise', 'weight', 'water'].includes(editingItem.type) ? editingItem : null} onSave={(type, d) => saveRecord(selectedDate, type, d, editingItem?.index)} categories={CATEGORIES} />
                    <DrinkForm initialData={editingItem && editingItem.type === 'drinks' ? editingItem : null} onSave={(d) => saveRecord(selectedDate, 'drinks', d, editingItem?.index)} iceOptions={ICE_OPTIONS} sugarOptions={SUGAR_OPTIONS} />
                    <ExerciseForm initialData={editingItem && editingItem.type === 'exercise' ? editingItem : null} onSave={(d) => saveRecord(selectedDate, 'exercise', d, editingItem?.index)} />
                    <SimpleHealthForms onWeight={(amount) => saveRecord(selectedDate, 'weight', {amount})} onWater={(amount) => saveRecord(selectedDate, 'water', {amount})} currentWeight={records[selectedDate]?.weight} currentWater={records[selectedDate]?.water} />
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// --- 小元件 ---

const FavoriteDisplay = ({ label, data, icon, activeColor, bgColor }) => (
  <div className={`${bgColor} p-5 rounded-3xl flex items-center justify-between border border-slate-100 shadow-sm`}>
    <span className="text-[10px] font-black text-[#90a4ae] uppercase tracking-[0.2em] flex items-center gap-2">
      {icon} {label}
    </span>
    <div className="flex flex-col items-end gap-1 max-w-[65%]">
      <span className={`text-sm font-black text-right break-words leading-tight ${activeColor}`}>{data.text}</span>
      {data.count > 0 && <span className="text-[10px] font-black bg-white/50 text-[#90a4ae] px-2 py-0.5 rounded-lg border border-slate-200 shadow-sm">共 {data.count} {data.unit}</span>}
    </div>
  </div>
);

const StatCard = ({ title, value, unit, icon, color, bgColor }) => (
  <div className={`${bgColor} border border-white/50 p-8 rounded-[2.5rem] flex flex-col gap-2 shadow-sm transition-transform hover:scale-[1.02]`}>
    <div className={`p-4 w-fit rounded-2xl bg-white shadow-sm ${color}`}>{icon}</div>
    <p className="text-[10px] font-black text-[#90a4ae] uppercase tracking-[0.2em] mt-4">{title}</p>
    <p className={`text-2xl font-black ${color}`}>
      {typeof value === 'number' ? value.toLocaleString() : value} {unit && <span className="text-xs font-normal opacity-40 ml-1">{unit}</span>}
    </p>
  </div>
);

const RecordColumn = ({ title, items, onEdit, onDelete, render, footer, header }) => (
  <div className="bg-[#f8f9fa] rounded-[3rem] p-7 border border-slate-100 shadow-sm flex flex-col min-h-[400px]">
    <h4 className="font-black text-[#b0bec5] mb-8 flex items-center justify-between text-[10px] uppercase tracking-[0.2em]">
      {title}
      <span className="bg-white text-[#90a4ae] px-3 py-1 rounded-full border border-slate-100">{items.length}</span>
    </h4>
    {header}
    <div className="space-y-5 flex-1 overflow-visible">
      {items.length === 0 && (
        <div className="h-full flex flex-col items-center justify-center opacity-10 py-20">
          <Utensils size={48}/>
          <p className="text-xs font-black mt-2 tracking-widest">EMPTY</p>
        </div>
      )}
      {items.map((item, i) => (
        <div key={i} className="group relative bg-white border border-slate-100 p-5 rounded-[2rem] hover:shadow-lg transition-all hover:-translate-y-1">
          {render(item)}
          <div className="absolute -top-2 -right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-all">
            <button onClick={() => onEdit(item, i)} className="bg-[#91a5b8] text-white p-2 rounded-full shadow-lg hover:bg-[#7e8da1]"><Edit2 size={12}/></button>
            <button onClick={() => onDelete(i)} className="bg-[#e57373] text-white p-2 rounded-full shadow-lg hover:bg-[#ef5350]"><Trash2 size={12}/></button>
          </div>
        </div>
      ))}
    </div>
    {footer}
  </div>
);

// --- 表單元件 (莫蘭迪色系優化) ---

const MealForm = ({ initialData, onSave, categories }) => {
  const [data, setData] = useState({ type: 'breakfast', brand: '', name: '', amount: '', note: '' });
  useEffect(() => { if(initialData) setData(initialData.data); else setData({ type: 'breakfast', brand: '', name: '', amount: '', note: '' }); }, [initialData]);
  const submit = () => { if(!data.name || !data.amount) return; onSave(data.type, data); setData({ type: 'breakfast', brand: '', name: '', amount: '', note: '' }); };
  return (
    <div className="bg-white p-7 rounded-[3rem] border border-slate-100 space-y-4 shadow-sm hover:border-[#91a5b8]/30 transition-all">
      <div className="flex items-center gap-2 mb-2 font-black text-xs text-[#546e7a] uppercase tracking-widest"><Utensils size={18} className="text-[#91a5b8]"/> 飲食項目</div>
      <select className="w-full text-xs font-bold bg-[#f1f3f5] rounded-2xl p-4 outline-none focus:ring-2 focus:ring-[#91a5b8]/20 transition-all" value={data.type} onChange={e => setData({...data, type: e.target.value})}>
        {['breakfast', 'lunch', 'dinner', 'nightSnack', 'instantNoodles'].map(k => <option key={k} value={k}>{categories[k].label}</option>)}
      </select>
      <div className="space-y-3">
        <input placeholder="品牌 / 店家" className="w-full text-xs font-medium bg-[#f8f9fa] border border-slate-100 rounded-2xl p-4" value={data.brand} onChange={e => setData({...data, brand: e.target.value})} />
        <input placeholder="食物名稱 *" className="w-full text-xs font-bold bg-[#f8f9fa] border border-slate-100 rounded-2xl p-4" value={data.name} onChange={e => setData({...data, name: e.target.value})} />
        <input type="number" placeholder="金額 *" className="w-full text-xs font-bold bg-[#f8f9fa] border border-slate-100 rounded-2xl p-4" value={data.amount} onChange={e => setData({...data, amount: e.target.value})} />
        <textarea placeholder="備註..." className="w-full text-xs font-medium bg-[#f8f9fa] border border-slate-100 rounded-2xl p-4 h-24 resize-none" value={data.note} onChange={e => setData({...data, note: e.target.value})} />
      </div>
      <button onClick={submit} className="w-full bg-[#91a5b8] text-white text-xs font-black py-4 rounded-2xl shadow-lg shadow-[#91a5b8]/20 hover:bg-[#7e8da1] transition-all uppercase tracking-widest">{initialData ? '更新' : '加入紀錄'}</button>
    </div>
  );
};

const DrinkForm = ({ initialData, onSave, iceOptions, sugarOptions }) => {
  const [data, setData] = useState({ brand: '', name: '', amount: '', ice: '去冰', sugar: '無糖', note: '' });
  useEffect(() => { if(initialData) setData(initialData.data); else setData({ brand: '', name: '', amount: '', ice: '去冰', sugar: '無糖', note: '' }); }, [initialData]);
  const submit = () => { if(!data.name || !data.amount) return; onSave(data); setData({ brand: '', name: '', amount: '', ice: '去冰', sugar: '無糖', note: '' }); };
  return (
    <div className="bg-[#fdfaf7] p-7 rounded-[3rem] border border-[#f2ece5] space-y-4 shadow-sm hover:border-[#c1a07d]/30 transition-all">
      <div className="flex items-center gap-2 mb-2 font-black text-xs text-[#c1a07d] uppercase tracking-widest"><DrinkIcon size={18}/> 手搖飲</div>
      <div className="space-y-3">
        <input placeholder="品牌 / 店家" className="w-full text-xs font-medium bg-white border border-[#f2ece5] rounded-2xl p-4" value={data.brand} onChange={e => setData({...data, brand: e.target.value})} />
        <input placeholder="飲料名稱 *" className="w-full text-xs font-bold bg-white border border-[#f2ece5] rounded-2xl p-4" value={data.name} onChange={e => setData({...data, name: e.target.value})} />
        <div className="grid grid-cols-2 gap-3">
          <select className="text-[10px] font-black bg-white border border-[#f2ece5] rounded-2xl p-4 outline-none" value={data.ice} onChange={e => setData({...data, ice: e.target.value})}>{iceOptions.map(o => <option key={o} value={o}>{o}</option>)}</select>
          <select className="text-[10px] font-black bg-white border border-[#f2ece5] rounded-2xl p-4 outline-none" value={data.sugar} onChange={e => setData({...data, sugar: e.target.value})}>{sugarOptions.map(o => <option key={o} value={o}>{o}</option>)}</select>
        </div>
        <input type="number" placeholder="金額 *" className="w-full text-xs font-bold bg-white border border-[#f2ece5] rounded-2xl p-4" value={data.amount} onChange={e => setData({...data, amount: e.target.value})} />
        <textarea placeholder="備註..." className="w-full text-xs font-medium bg-white border border-[#f2ece5] rounded-2xl p-4 h-24 resize-none" value={data.note} onChange={e => setData({...data, note: e.target.value})} />
      </div>
      <button onClick={submit} className="w-full bg-[#c1a07d] text-white text-xs font-black py-4 rounded-2xl shadow-lg shadow-[#c1a07d]/20 hover:bg-[#a68a6b] transition-all uppercase tracking-widest">{initialData ? '更新' : '加入紀錄'}</button>
    </div>
  );
};

const ExerciseForm = ({ initialData, onSave }) => {
  const [data, setData] = useState({ name: '', time: '', location: '', note: '' });
  useEffect(() => { if(initialData) setData(initialData.data); else setData({ name: '', time: '', location: '', note: '' }); }, [initialData]);
  const submit = () => { if(!data.name) return; onSave(data); setData({ name: '', time: '', location: '', note: '' }); };
  return (
    <div className="bg-[#f1f5f3] p-7 rounded-[3rem] border border-[#d1dbd6] space-y-4 shadow-sm">
      <div className="flex items-center gap-2 mb-2 font-black text-xs text-[#4c5e56] uppercase tracking-widest"><Dumbbell size={18} className="text-[#8da69d]"/> 運動</div>
      <div className="space-y-3">
        <input placeholder="運動項目 *" className="w-full text-xs font-bold bg-white border border-[#d1dbd6] rounded-2xl p-4" value={data.name} onChange={e => setData({...data, name: e.target.value})} />
        <input placeholder="地點" className="w-full text-xs font-medium bg-white border border-[#d1dbd6] rounded-2xl p-4" value={data.location} onChange={e => setData({...data, location: e.target.value})} />
        <input placeholder="時長 / 強度" className="w-full text-xs font-medium bg-white border border-[#d1dbd6] rounded-2xl p-4" value={data.time} onChange={e => setData({...data, time: e.target.value})} />
        <textarea placeholder="備註..." className="w-full text-xs font-medium bg-white border border-[#d1dbd6] rounded-2xl p-4 h-24 resize-none" value={data.note} onChange={e => setData({...data, note: e.target.value})} />
      </div>
      <button onClick={submit} className="w-full bg-[#8da69d] text-white text-xs font-black py-4 rounded-2xl shadow-lg shadow-[#8da69d]/20 hover:bg-[#6c857b] transition-all uppercase tracking-widest">{initialData ? '更新' : '加入紀錄'}</button>
    </div>
  );
};

const SimpleHealthForms = ({ onWeight, onWater, currentWeight, currentWater }) => {
  const [w, setW] = useState('');
  const [wt, setWt] = useState('');
  return (
    <div className="space-y-6">
      <div className="bg-[#455a64] p-8 rounded-[3rem] shadow-lg shadow-[#455a64]/20 group border border-white/10 transition-all">
         <div className="flex items-center gap-3 mb-4 text-[#b0bec5] font-black text-[10px] uppercase tracking-[0.2em]"><Scale size={20}/> 體重紀錄</div>
         <input type="number" step="0.1" placeholder={`${currentWeight || '--'} kg`} className="bg-white/10 border-2 border-transparent focus:border-white/30 rounded-2xl text-white text-2xl font-black w-full p-4 transition-all outline-none" value={w} onChange={e => setW(e.target.value)} onBlur={() => {if(w) onWeight(w); setW('');}} />
      </div>
      <div className="bg-[#9eb8c0] p-8 rounded-[3rem] shadow-lg shadow-[#9eb8c0]/20 group border border-white/10 transition-all">
         <div className="flex items-center gap-3 mb-4 text-white font-black text-[10px] uppercase tracking-[0.2em]"><Droplets size={20}/> 今日飲水</div>
         <input type="number" placeholder={`${currentWater || '--'} ml`} className="bg-white/20 border-2 border-transparent focus:border-white/40 rounded-2xl text-white text-2xl font-black w-full p-4 transition-all outline-none placeholder:text-white/50" value={wt} onChange={e => setWt(e.target.value)} onBlur={() => {if(wt) onWater(wt); setWt('');}} />
      </div>
      <div className="p-4 text-center">
        <p className="text-[10px] text-[#b0bec5] font-black tracking-[0.3em] uppercase italic">Consistency is Key</p>
      </div>
    </div>
  );
};

export default App;
